<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Portfolio Rebalancer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 800px; margin-top: 2rem; }
        .card { margin-bottom: 1rem; }
        .slider-container { margin: 1rem 0; }
        #connectButton { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Crypto Portfolio Rebalancer</h1>
        
        <div id="walletSection">
            <button id="connectButton" class="btn btn-primary">Connect MetaMask</button>
            <div id="walletInfo" style="display: none;">
                <p>Connected: <span id="walletAddress"></span></p>
                <button id="disconnectButton" class="btn btn-outline-secondary">Disconnect</button>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Current Portfolio</h5>
                <div id="portfolioInfo">
                    <p>Connect your wallet to view portfolio</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Target Allocations</h5>
                <div class="slider-container">
                    <label for="btcSlider">BTC: <span id="btcValue">50</span>%</label>
                    <input type="range" class="form-range" id="btcSlider" min="0" max="100" value="50">
                </div>
                <div class="slider-container">
                    <label for="ethSlider">ETH: <span id="ethValue">30</span>%</label>
                    <input type="range" class="form-range" id="ethSlider" min="0" max="100" value="30">
                </div>
                <div class="slider-container">
                    <label for="solSlider">SOL: <span id="solValue">20</span>%</label>
                    <input type="range" class="form-range" id="solSlider" min="0" max="100" value="20">
                </div>
                <button id="rebalanceButton" class="btn btn-success" disabled>Rebalance Portfolio</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script>
        let web3;
        let currentAccount = null;

        // Initialize Web3
        if (typeof window.ethereum !== 'undefined') {
            web3 = new Web3(window.ethereum);
            // Request account access
            window.ethereum.request({ method: 'eth_requestAccounts' })
                .catch((error) => {
                    if (error.code === 4001) {
                        console.log('User denied account access');
                    } else {
                        console.error('Error requesting account access:', error);
                    }
                });
        } else {
            alert('Please install MetaMask to use this application!');
        }

        // Connect to MetaMask
        document.getElementById('connectButton').addEventListener('click', async () => {
            try {
                // Request account access
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts',
                    params: [{ eth_accounts: {} }]
                });
                
                if (accounts.length === 0) {
                    throw new Error('No accounts found');
                }
                
                currentAccount = accounts[0];
                
                // Call our backend to connect wallet
                const response = await fetch('/api/connect-wallet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address: currentAccount })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to connect wallet');
                }
                
                const result = await response.json();
                if (result.status === 'connected') {
                    document.getElementById('walletAddress').textContent = `${currentAccount.substring(0, 6)}...${currentAccount.substring(38)}`;
                    document.getElementById('walletInfo').style.display = 'block';
                    document.getElementById('connectButton').style.display = 'none';
                    document.getElementById('rebalanceButton').disabled = false;
                    
                    // Display wallet information
                    let walletInfoHtml = `
                        <div class="list-group">
                            <div class="list-group-item">
                                <strong>ETH Balance:</strong> ${result.eth_balance.toFixed(4)} ETH
                            </div>
                    `;
                    
                    // Add token balances
                    for (const [token, balance] of Object.entries(result.token_balances)) {
                        walletInfoHtml += `
                            <div class="list-group-item">
                                <strong>${token} Balance:</strong> ${balance.toFixed(4)}
                            </div>
                        `;
                    }
                    
                    walletInfoHtml += '</div>';
                    document.getElementById('portfolioInfo').innerHTML = walletInfoHtml;
                    
                    // Fetch detailed portfolio
                    fetchPortfolio();
                } else {
                    throw new Error(result.error || 'Failed to connect wallet');
                }
            } catch (error) {
                console.error('Error connecting to MetaMask:', error);
                alert('Error connecting wallet: ' + error.message);
            }
        });

        // Disconnect wallet
        document.getElementById('disconnectButton').addEventListener('click', () => {
            currentAccount = null;
            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('connectButton').style.display = 'block';
            document.getElementById('rebalanceButton').disabled = true;
            document.getElementById('portfolioInfo').innerHTML = '<p>Connect your wallet to view portfolio</p>';
        });

        // Update slider values
        document.getElementById('btcSlider').addEventListener('input', (e) => {
            document.getElementById('btcValue').textContent = e.target.value;
        });

        document.getElementById('ethSlider').addEventListener('input', (e) => {
            document.getElementById('ethValue').textContent = e.target.value;
        });

        document.getElementById('solSlider').addEventListener('input', (e) => {
            document.getElementById('solValue').textContent = e.target.value;
        });

        // Fetch portfolio
        async function fetchPortfolio() {
            if (!currentAccount) return;
            
            try {
                const response = await fetch(`/api/portfolio?address=${currentAccount}`);
                const portfolio = await response.json();
                
                let portfolioHtml = '<div class="list-group">';
                
                // Display token data
                for (const [token, data] of Object.entries(portfolio)) {
                    if (token !== 'total_value') {
                        portfolioHtml += `
                            <div class="list-group-item">
                                ${token}: ${data.amount} (${data.value} USD)
                            </div>
                        `;
                    }
                }
                
                // Display total value separately
                portfolioHtml += `
                    <div class="list-group-item">
                        <strong>Total Portfolio Value:</strong> ${portfolio.total_value} USD
                    </div>
                `;
                
                portfolioHtml += '</div>';
                document.getElementById('portfolioInfo').innerHTML = portfolioHtml;
            } catch (error) {
                console.error('Error fetching portfolio:', error);
            }
        }

        // Rebalance portfolio
        document.getElementById('rebalanceButton').addEventListener('click', async () => {
            if (!currentAccount) return;

            const allocations = {
                BTC: parseInt(document.getElementById('btcValue').textContent),
                ETH: parseInt(document.getElementById('ethValue').textContent),
                SOL: parseInt(document.getElementById('solValue').textContent)
            };

            try {
                const response = await fetch('/api/rebalance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: currentAccount,
                        allocations: allocations
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert('Rebalancing transaction prepared!');
                    fetchPortfolio();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error rebalancing:', error);
                alert('Error rebalancing portfolio');
            }
        });
    </script>
</body>
</html> 